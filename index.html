<html>
<head>
    <title>ToorCon Schedule</title>
    <link href="css/style.css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
</head>
<body>
<div class="main">
<img class="background_art" src="img/TCBG_2016.png" />

    <div id="clock" class="schedule-speaker"></div>
    
        <div id="schedule" class="schedule" >
            <span>
                <div class="schedule-time">00:00</div>
                <div class="schedule-box"><span class="schedule-speaker">Loading Schedule</span><br /><span class="schedule-title"></span></div>
            </span>
        </div>

</div>

<script src="js/dateFormat.js"></script>
<script src="js/clock.js"></script>
<script>
function ISODateString(d){
 function pad(n){return n<10 ? '0'+n : n}
 return d.getUTCFullYear()+'-'
      + pad(d.getUTCMonth()+1)+'-'
      + pad(d.getUTCDate())+'T'
      + pad(d.getUTCHours())+':'
      + pad(d.getUTCMinutes())+':'
      + pad(d.getUTCSeconds())+'Z'
}

//var d = new Date(2016, 5, 9, 13, 20); //now
var d = new Date(); //now
//var timeMin = ISODateString(d);
var timeMin = ISODateString(new Date(d.getFullYear(), d.getMonth(), d.getDate())); // midnight
var timeMax = ISODateString(new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)); // midnight

</script>

 <script>
var calendars = {
    a: 'toorcon.org_5gc3slk5srkld07gkd2ank587s%40group.calendar.google.com',
    b: 'carlos%40toorcon.org',
};
var data;

if (!calendars[window.location.hash.substr(1)]) {
    window.location.hash = "#a";
}


// TODO this logich should be moved to a function to handle day changes
var CALENDAR_ID = calendars[window.location.hash.substr(1)];
//https://developers.google.com/google-apps/calendar/v3/reference/events/list#parameters
var API_KEY = 'AIzaSyAwQwg4O6M_G1hqWxsRJMMAohIm57WmhTI';
var URL = 'https://www.googleapis.com/calendar/v3/calendars/'+CALENDAR_ID+'/events?key='+API_KEY+'&timeMin='+timeMin+'&timeMax='+timeMax;
//var URL = 'https://www.googleapis.com/calendar/v3/calendars/'+CALENDAR_ID+'/events?key='+API_KEY;

function trimString(str) {
    var len = 100;
    if(!str) {
        return "";
    }
    var r = str.substring(0,len);
    if (str.length > len) {
        r = r + "&hellip;";
    }
    return r;
}

// get template
var schedule = document.getElementById("schedule");
var template = schedule.children[0];

function renderCal() {
    if (!data) {
        return;
    }
    // remove if first load
    template.remove();

    // remove existing events
    while (schedule.firstChild) {
        schedule.removeChild(schedule.firstChild);
    }

// TODO this needs to be dynalicly now...
    //var now = new Date();
    //var now = d;
    var now = new Date();
    var events = data.items;
    // sort
    events.sort(function(a,b) {
        return new Date(a.start.dateTime || a.start.date).getTime() - new Date(b.start.dateTime || b.start.date).getTime();
    });

    // add new events
    for (var i=0; i<events.length && i < 12; i++) {
        var e = events[i];
        var parts = e.summary.split('-',2);
        var title = parts[0];
        var description = "";
        if (parts.length > 1) {
            description = parts[1];
        }
        console.log("title", title);
        console.log("des", description);
        //var title = e.summary;
        //var description = trimString(e.description);
        var start = new Date(e.start.dateTime);
        var end = new Date(e.end.dateTime);
 
        //console.log(title, start, end, description);
        //if (now < end) {
            var evt = template.cloneNode(true);
            var stime = evt.getElementsByClassName("schedule-time")[0];
            var sspeaker = evt.getElementsByClassName("schedule-speaker")[0];
            var stitle = evt.getElementsByClassName("schedule-title")[0];
            stime.innerText = start.format("HH:MM");
            sspeaker.innerHTML = title;
            stitle.innerHTML = description;
            if (start < now && now < end) {
                var p = stitle.parentElement;
                p.className = p.className + " event-current";
            }
            if (now > end) {
                var p = stitle.parentElement;
                p.className = p.className + " event-old";
            }
            schedule.appendChild(evt);
        //}
    }
}

function getData(newdata) {
    if (newdata) {
        data = newdata;
        renderCal();
    }
}

function updateFeed() {
    console.log("Updating")
    $.getJSON(URL, getData);
}

updateFeed();
setInterval(updateFeed,5*60*1000); // every 5 minutes
setInterval(renderCal,60*1000); // every 1 minute
</script>
</body>
</html>
